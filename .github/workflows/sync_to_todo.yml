name: Advanced Sync to ToDo Project

on:
  issues:
    types: [opened, labeled, unlabeled, edited]

jobs:
  sync_fields:
    runs-on: ubuntu-latest
    steps:
      - name: Add to Project & Sync Priority
        env:
          GH_TOKEN: ${{ secrets.CONNECT_TODO }}
        run: |
          # 変数設定
          ISSUE_URL="${{ github.event.issue.html_url }}"
          USER="medakoro0321"
          PROJECT_NUM="9"
          
          # プロジェクトにアイテムを追加（--owner ではなく --user を使用）
          echo "Adding issue to project..."
          item_id=$(gh project item-add "$PROJECT_NUM" \
            --user "$USER" \
            --url "$ISSUE_URL" \
            --format json | jq -r '.id')
          
          if [ -z "$item_id" ] || [ "$item_id" == "null" ]; then
            echo "::error::Failed to add item to project"
            exit 1
          fi
          
          echo "✓ Added with item ID: $item_id"
          
          # ラベルからPriorityを判定
          LABELS='${{ toJSON(github.event.issue.labels.*.name) }}'
          
          PRIORITY=""
          if echo "$LABELS" | jq -e 'index("★★★")' > /dev/null; then
            PRIORITY="★★★"
          elif echo "$LABELS" | jq -e 'index("★★")' > /dev/null; then
            PRIORITY="★★"
          elif echo "$LABELS" | jq -e 'index("★")' > /dev/null; then
            PRIORITY="★"
          fi
          
          # Priorityを設定
          if [ -n "$PRIORITY" ]; then
            echo "Setting priority to: $PRIORITY"
            gh project item-edit \
              --id "$item_id" \
              --project-id "$PROJECT_NUM" \
              --user "$USER" \
              --field-id "Priority" \
              --text "$PRIORITY"
          fi
